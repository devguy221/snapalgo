<!doctype html>
<html>
  </head>
    <title>Hello, Snaps!</title>
    <link rel="icon" type="image/svg" href="./images/icon.svg"/>
    <script src="encoding-indexes.js"></script>
    <script src="encoding.js"></script>
  </head>

  <body>
    <h1>Algorand On Metamask Proof of Concept</h1>
    <h2>(testnet)</h2>
    <details>
      <summary>Instructions</summary>
      <ul>
        <li>First, Uninstall metamask and install metamask Flask</li>
        <li>then, click "Connect". Then, try out the other buttons!</li>
        <li>Please note that:</li>
      </ul>
    </details>
    <br/>

    <button class="connect">Connect</button>
    <button class="showMnemonic">Display Mnemonic</button>
    <button class="getBalance">Get Balance</button>
    <button id="getTransactionsButton">getTransactions</button>
    <br>
    <input type="checkbox" id="testnet" checked/>
    <label for="testnet">Testnet</label>
    <br>
    <button class="getAddress">Get Address</button>
    <p id="address"></p>
    <br>
    <input id="SendTo" value="HZ57J3K46JIJXILONBBZOHX6BKPXEM2VVXNRFSUED6DKFD5ZD24PMJ3MVA" placeholder="reciver address"/>
    <input id="Amount" value="100000" placeholder="amount" type="number"/>
    <button class="transact">Transact</button>
    <button class="testAddress">Test Address</button>
    <br>
    <button onClick="clearAccounts()">clear Accounts</button>
    <br>
    <div id="transactionOutput" style="overflow-y: scroll;"></div>
    <p>Sign data</p>
    <input id="data"/>
    <button id="signButton">sign</button>
    <div style="width:400px; max-width: 400px; word-break: break-all;" id="signature"></div> 
  </body>

  <script>
    //const snapId = `npm:algorand`;
    const snapId = `local:${window.location.href}`;
    const connectButton = document.querySelector('button.connect')
    const sendButton = document.querySelector('button.showMnemonic')
    const balanceButton = document.querySelector('button.getBalance')
    const transactButton = document.querySelector('button.transact')
    const getAddressButton = document.querySelector('button.getAddress')
    const checkbox = document.getElementById('testnet')
    const transactionButton = document.getElementById('getTransactionsButton')
    const testAddressButton = document.querySelector('button.testAddress')
    const data = document.getElementById('data')
    const signButton = document.getElementById('signButton')
    testAddressButton.addEventListener('click', isValidAddress)
    connectButton.addEventListener('click', connect)
    sendButton.addEventListener('click', display_mnemonic)
    balanceButton.addEventListener('click', getBalance)
    transactButton.addEventListener('click', transact)
    getAddressButton.addEventListener('click', getAddress)
    transactionButton.addEventListener('click', getTransactions)
    signButton.addEventListener('click', signData)
    // here we get permissions to interact with and install the snap
    async function connect () {
      await ethereum.request({
        method: 'wallet_enable',
        params: [{
          wallet_snap: { [snapId]: {} },
        }]
      })
    }
    
    async function signData(){
      console.log("here2")
      let thing = new Uint8Array(new TextEncoder().encode(document.getElementById('data').value));
      console.log(thing)
      let sig = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: [snapId, {
          method: 'signData',
          data: thing
        }]        
      })
      console.log(sig)
      document.getElementById('signature').innerHTML = JSON.stringify(sig);
    }
    
    async function clearAccounts(){
      await ethereum.request({
        method: 'wallet_invokeSnap',
        params: [snapId, {
          method: 'clearAccounts',
        }]        
      })
    }

    async function isValidAddress(){
      const address = document.getElementById('SendTo').value
      const isValid = await ethereum.request({
        method: 'wallet_invokeSnap',
        params: [snapId, {
          method: 'isValidAddress',
          address: document.getElementById('SendTo').value
        }]
      })
      alert("adress is valid : " + isValid)
    }

    async function getAddress(){
      let address = await ethereum.request({
          method: 'wallet_invokeSnap',
          params: [snapId, {
            method: 'getAddress',
            testnet: checkbox.checked
          }]
        })
      document.getElementById('address').innerHTML = address
    }

    // here we call the snap's "hello" method
    async function getBalance(){
      try{
        const response = await ethereum.request({
          method: 'wallet_invokeSnap',
          params: [snapId, {
            method: 'displayBalance',
            testnet: checkbox.checked
          }]
        })
      }catch(e){
        console.error(e)
        alert(err.message)
      }
    }
    async function getTransactions(){
      try{
        const response = await ethereum.request({
          method: 'wallet_invokeSnap',
          params: [snapId, {
            method: 'getTransactions',
            testnet: checkbox.checked
          }]
        })
        document.getElementById('transactionOutput').innerHTML = JSON.stringify(response);
      }catch(e){
        console.error(e)
        alert(err.message)
      }
    }

    async function transact(){
      try {
        const response = await ethereum.request({
          method: 'wallet_invokeSnap',
          params: [snapId, {
            method: 'transfer',
            testnet: checkbox.checked,
            to: document.querySelector('#SendTo').value,
            amount: document.querySelector('#Amount').value
          }]
        })
        console.log("transaction returned");
        console.log(response);
      } catch (err) {
        console.trace(err)
        console.error(err)
        alert('Problem happened: ' + err.message || err)
      }
    }      
      
    
    async function display_mnemonic () {
      try {
        const response = await ethereum.request({
          method: 'wallet_invokeSnap',
          params: [snapId, {
            method: 'displayMnemonic'
          }]
        })
      } catch (err) {
        console.error(err)
        alert('Problem happened: ' + err.message || err)
      }
    }
  </script>
</html>
