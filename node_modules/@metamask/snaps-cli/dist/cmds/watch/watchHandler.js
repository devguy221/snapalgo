"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.watch = void 0;
const chokidar_1 = __importDefault(require("chokidar"));
const utils_1 = require("../../utils");
const bundle_1 = require("../build/bundle");
const evalHandler_1 = require("../eval/evalHandler");
const manifestHandler_1 = require("../manifest/manifestHandler");
/**
 * Watch a directory and its subdirectories for changes, and build when files
 * are added or changed.
 *
 * Ignores 'node_modules' and dotfiles.
 * Creates destination directory if it doesn't exist.
 *
 * @param argv - arguments as an object generated by yargs
 * @param argv.src - The source file path
 * @param argv.dist - The output directory path
 * @param argv.'outfileName' - The output file name
 */
async function watch(argv) {
    const { dist, eval: shouldEval, manifest, outfileName, src } = argv;
    if (outfileName) {
        utils_1.validateOutfileName(outfileName);
    }
    await utils_1.validateFilePath(src);
    await utils_1.validateDirPath(dist, true);
    const rootDir = src.indexOf('/') === -1 ? '.' : src.substring(0, src.lastIndexOf('/') + 1);
    const outfilePath = utils_1.getOutfilePath(dist, outfileName);
    const buildSnap = async (path, logMessage) => {
        if (logMessage !== undefined) {
            console.log(logMessage);
        }
        try {
            await bundle_1.bundle(src, outfilePath, argv, utils_1.loadConfig().bundlerCustomizer);
            if (manifest) {
                await manifestHandler_1.manifestHandler(argv);
            }
            if (shouldEval) {
                await evalHandler_1.snapEval(Object.assign(Object.assign({}, argv), { bundle: outfilePath }));
            }
        }
        catch (error) {
            utils_1.logError(`Error ${path === undefined
                ? 'during initial build'
                : `while processing "${path}"`}.`, error);
        }
    };
    chokidar_1.default
        .watch(rootDir, {
        ignoreInitial: true,
        ignored: [
            '**/node_modules/**',
            `**/${dist}/**`,
            `**/test/**`,
            `**/tests/**`,
            `**/*.test.js`,
            `**/*.test.ts`,
            /* istanbul ignore next */
            (str) => str !== '.' && str.startsWith('.'),
        ],
    })
        .on('ready', buildSnap)
        .on('add', (path) => buildSnap(path, `File added: ${path}`))
        .on('change', (path) => buildSnap(path, `File changed: ${path}`))
        .on('unlink', (path) => console.log(`File removed: ${path}`))
        .on('error', (error) => {
        utils_1.logError(`Watcher error: ${error.message}`, error);
    })
        .add(rootDir);
    console.log(`Watching '${rootDir}' for changes...`);
}
exports.watch = watch;
//# sourceMappingURL=watchHandler.js.map