"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.watch = void 0;
const chokidar_1 = __importDefault(require("chokidar"));
const bundle_1 = require("../build/bundle");
const utils_1 = require("../../utils");
/**
 * Watch a directory and its subdirectories for changes, and build when files
 * are added or changed.
 *
 * Ignores 'node_modules' and dotfiles.
 * Creates destination directory if it doesn't exist.
 *
 * @param argv - arguments as an object generated by yargs
 * @param argv.src - The source file path
 * @param argv.dist - The output directory path
 * @param argv.'outfileName' - The output file name
 */
async function watch(argv) {
    const { src, dist, outfileName } = argv;
    if (outfileName) {
        utils_1.validateOutfileName(outfileName);
    }
    await utils_1.validateFilePath(src);
    await utils_1.validateDirPath(dist, true);
    const rootDir = src.indexOf('/') === -1 ? '.' : src.substring(0, src.lastIndexOf('/') + 1);
    const outfilePath = utils_1.getOutfilePath(dist, outfileName);
    const watcher = chokidar_1.default.watch(rootDir, {
        ignoreInitial: true,
        ignored: [
            '**/node_modules/**',
            `**/${dist}/**`,
            `**/test/**`,
            `**/tests/**`,
            `**/*.test.js`,
            `**/*.test.ts`,
            /* istanbul ignore next */
            (str) => str !== '.' && str.startsWith('.'),
        ],
    });
    watcher
        .on('ready', () => {
        bundle_1.bundle(src, outfilePath, argv);
    })
        .on('add', (path) => {
        console.log(`File added: ${path}`);
        bundle_1.bundle(src, outfilePath, argv);
    })
        .on('change', (path) => {
        console.log(`File changed: ${path}`);
        bundle_1.bundle(src, outfilePath, argv);
    })
        .on('unlink', (path) => console.log(`File removed: ${path}`))
        .on('error', (err) => {
        utils_1.logError(`Watcher error: ${err.message}`, err);
    });
    watcher.add(`${rootDir}`);
    console.log(`Watching '${rootDir}' for changes...`);
}
exports.watch = watch;
//# sourceMappingURL=watchHandler.js.map